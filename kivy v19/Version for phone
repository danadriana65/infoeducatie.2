import kivy
from kivy.app import App
from kivy.uix.screenmanager import ScreenManager, Screen
from PIL import Image as PILImage, ImageDraw
from kivy.uix.image import Image
from kivy.uix.label import Label
from kivy.uix.videoplayer import VideoPlayer
from kivy.uix.video import Video
from kivy.uix.button import Button
from kivy.uix.boxlayout import BoxLayout
from kivy.uix.popup import Popup
import os
import sys
import json
from kivy.uix.textinput import TextInput
from kivy.uix.filechooser import FileChooserListView
from kivy.uix.floatlayout import FloatLayout
from kivy.resources import resource_find

def load_user_credentials():
    try:
        with open("user_credentials.json","r") as f:
            return json.load(f)
    except (FileNotFoundError, json.JSONDecodeError):
            return {}
def store_user_info(username, password, email):
    user_data = load_user_credentials()
    if username in user_data:
        return "User already exists"
    else:
        user_data[username]={"password":password, "email":email}
        with open("user_credentials","w") as f:
            json.dump(user_data,f,indent=4)
        return "Account created successfully"
def verify_user(username, password):
    user_data = load_user_credentials()
    return username in user_data and user_data[username]["password"] == password

class WelcomeScreen(Screen):
    def __init__(self, **kwargs):
        super().__init__(**kwargs)
        layout = BoxLayout(orientation="vertical")
        layout.add_widget(Label(text="Welcome to App!", font_size=24))

        start_button = Button(text="Start Video")
        start_button.bind(on_press=self.go_to_video)
        layout.add_widget(start_button)

        self.add_widget(layout)

    def go_to_video(self, instance):
        self.manager.current = "video_screen"

class VideoScreen(Screen):
    def __init__(self, **kwargs):
        super().__init__(**kwargs)
        self.layout = BoxLayout(orientation="vertical")

        # Default video path
        self.default_video_path = "C:/Users/Adriana/infoeducatie.2-3/WhatsApp Video 2025-03-31 at 12.10.50_af799974.mp4"

        if not os.path.exists(self.default_video_path):
            self.layout.add_widget(Label(text="Default video file not found! Please select a file."))

            file_chooser = FileChooserListView(filters=["*.mp4"])
            self.layout.add_widget(file_chooser)

            select_button = Button(text="Select File")
            select_button.bind(on_press=lambda x: self.play_video(file_chooser.selection))
            self.layout.add_widget(select_button)
        else:
            self.play_video(self.default_video_path)

        self.add_widget(self.layout)

    def play_video(self, video_path):
        if not video_path:
            return

        self.layout.clear_widgets()
        video_player = VideoPlayer(source=video_path, state="play")
        video_player.bind(state=self.on_video_end)
        self.layout.add_widget(video_player)

    def on_video_end(self, instance, value):
        if value == "stop":  # Detect video completion
            self.manager.current = "grid_screen"
class LoginScreen(Screen):
    def __init__(self, **kwargs):
        super().__init__(**kwargs)
        self.layout = FloatLayout()

        self.video_path = r"C:\Users\Adriana\infoeducatie.2-3\infoeducatie.2\WhatsApp Video 2025-04-05 at 20.39.03_78657a3f.mp4"
        if os.path.exists(self.video_path):
            self.video_player = VideoPlayer(source=self.video_path, play=True, options={"eos": "loop"})
            self.layout.add_widget(self.video_player)

        self.layout.add_widget(Label(text="Welcome to Cosmiccode!", font_size=24, pos_hint={"center_x": 0.5, "center_y": 0.85}))

        self.username = TextInput(hint_text="Username", size_hint=(0.5, 0.1), pos_hint={"center_x": 0.5, "center_y": 0.65})
        self.layout.add_widget(self.username)

        self.email = TextInput(hint_text="Your Email", size_hint=(0.5, 0.1), pos_hint={"center_x": 0.5, "center_y": 0.55})
        self.layout.add_widget(self.email)

        self.password = TextInput(hint_text="Password", password=True, size_hint=(0.5, 0.1), pos_hint={"center_x": 0.5, "center_y": 0.45})
        self.layout.add_widget(self.password)

        self.message_label = Label(text="", pos_hint={"center_x": 0.5, "center_y": 0.35})
        self.layout.add_widget(self.message_label)

        submit_button = Button(text="Create Account", size_hint=(0.3, 0.1), pos_hint={"center_x": 0.5, "center_y": 0.25}, on_press=self.submit_username)
        self.layout.add_widget(submit_button)

        login_button = Button(text="Login", size_hint=(0.3, 0.1), pos_hint={"center_x": 0.5, "center_y": 0.15}, on_press=self.login)
        self.layout.add_widget(login_button)

        self.add_widget(self.layout)

    def submit_username(self, instance):
        entered_username = self.username.text.strip()
        entered_password = self.password.text.strip()
        entered_email = self.email.text.strip()

        if not entered_username or not entered_password or not entered_email:
            self.message_label.text = "Error: Please fill all fields!"
        else:
            result = store_user_info(entered_username, entered_password, entered_email)
            self.message_label.text = result

    def login(self, instance):
        entered_username = self.username.text.strip()
        entered_password = self.password.text.strip()

        if verify_user(entered_username, entered_password):
            self.manager.get_screen("grid_screen").set_user_details(entered_username)  # Pass user data
            self.manager.current = "main"
        else:
            self.message_label.text = "Invalid credentials!"
class GridScreen(Screen):
    def __init__(self, **kwargs):
        super().__init__(**kwargs)
        self.layout = FloatLayout()

        # Background Video
        self.video_path = r"C:\Users\Adriana\infoeducatie.2-3\infoeducatie.2\WhatsApp Video 2025-04-05 at 20.39.03_78657a3f.mp4"
        if os.path.exists(self.video_path):
            self.video_player = VideoPlayer(source=self.video_path, play=True, options={"eos": "loop"})
            self.layout.add_widget(self.video_player)

        # Overlay UI Elements
        self.welcome_label = Label(text="Welcome, User!", font_size=24, pos_hint={"center_x": 0.5, "center_y": 0.85})
        self.layout.add_widget(self.welcome_label)

        sign_out_button = Button(text="Continue", size_hint=(0.3, 0.1), pos_hint={"center_x": 0.5, "center_y": 0.15}, on_press=self.sign_out)
        self.layout.add_widget(sign_out_button)

        self.add_widget(self.layout)

    def set_user_details(self, username):
        self.welcome_label.text = f"Welcome, {username}!"

    def sign_out(self, instance):
        self.manager.current = "login_screen"
class MainScreen(Screen):
    def __init__(self,**kwargs):
     super().__init__(**kwargs)
     layout = BoxLayout(orientation = "vertical")
     video_path = "C:\\Users\\Adriana\\Desktop\\grid\\WhatsApp Video 2025-04-05 at 20.39.03_78657a3f.mp4"
     if os.path.exists(video_path):
         video = Video(source=video_path,play=True, allow_stretch=True)
         layout.add_widget(video)
     options_layout=BoxLayout(orientation = "horizontal")
     languages = [("C++", "C:\\Users\\Adriana\\Desktop\\grid\\ISO_C++_Logo.svg(1).png"), 
                     ("Python", "C:\\Users\\Adriana\\Desktop\\grid\\Python.svg(1).png"),
                     ("JavaScript", "C:\\Users\\Adriana\\Desktop\\grid\\1698604163003(1).png")]
     for lang, sticker in languages:
         btn = Button(text=lang, size_hint=(None, None), width=250, height=50)
         img = Image(source=sticker, size_hint=(None, None), width=50, height=50)

         options_layout.add_widget(btn)
         options_layout.add_widget(img)
     undo_button = Button(text="Undo", size_hint=(0.3, 0.1), pos_hint={"center_x": 0.5, "center_y": 0.15}, on_press=self.undo)
     layout.add_widget(undo_button)

     layout.add_widget(options_layout)
     self.add_widget(layout)
    
    def undo(self, instance):
         self.manager.current="login_screen"
class SettingsScreen(Screen):
    def __init__(self,**kwargs):
        super().__init__(**kwargs)
        self.layout = BoxLayout(orientation="vertical", padding=20, spacing=10)
        
        user_data = load_user_credentials()
        title_label = Label(text="Settings", font_size=24)
        self.layout.add_widget(title_label)
        username_label= Label(text=f"Username:{user_data['username']}", font_size=18)
        self.layout.add_widget(username_label)
        email_label = Label(text=f"Email:{user_data['email']}",font_size=18)
        self.layout.add_widget(email_label)
        self.profile_label = Label("No profile picture selected")
        self.layout.add_widget(self.profile_label)
        if "profile_picture" in user_data and os.path.exists(user_data["profile_picture"]):
            try:
                profile_picture = PILImage.open(user_data["profile_picture"]).convert("RGBA")
                mask = PILImage.new("L",profile_picture.size, 0)
                draw = ImageDraw.Draw(mask)
                draw.ellipse((0,0,profile_picture.size[0] ,profile_picture[1]),fill=255)
                circular_profile= PILImage.new("RGBA", profile_picture.size)
                circular_profile.paste(profile_picture, (0, 0), mask)
                circular_profile=circular_profile.resize((100,100))
                circular_profile.save("circular_profile.png")

                self.profile_img = Image(source="circular_profile.png",size_hint=(None,None), width=100, height=100)
                self.layout.add_widget(self.profile_img)
            except Exception as e:
                self.profile_label.text = f"Error loading image: {e}"
        choose_profile_button = Button(text="Choose profile picture", size_hint=(None,None), width=200, height=50)
        choose_profile_button.bind(open_press=self.choose_profile_picture)
        self.layout.add_widget(choose_profile_button)
        remove_profile_button = Button(text= "Remove profile pcture", size_hint=(None,None), width=200, height=50)
        remove_profile_button.bind(open_press=self.remove_profile_picture)
        self.layout.add_widget(remove_profile_button)
    def choose_profile_picture(self,instance):
        file_popup = FileChooserListView(filters = ["*.png", "*.jpg", "*.jpeg"])
        self.layout.add_widget(file_popup)
    def remove_profile_picture(self,instance):
        self.profile_label.text = "No profile picture selected"
        if os.path.exists("circular_profile.png"):
            os.remove("circular_picture.png")
class MyApp(App):
    def build(self):
        sm = ScreenManager()
        sm.add_widget(WelcomeScreen(name="welcome_screen"))
        sm.add_widget(VideoScreen(name="video_screen"))
        sm.add_widget(GridScreen(name="grid_screen"))
        sm.add_widget(LoginScreen(name="login_screen"))
        sm.add_widget(MainScreen(name="main"))
        sm.add_widget(SettingsScreen(name="settings_screen"))
        return sm

MyApp().run()
